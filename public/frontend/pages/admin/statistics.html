<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.1/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-green-500 p-4 text-white">
        <div class="container mx-auto">
            <div class="flex justify-between">
                <div class="font-bold text-lg">
                   Eco-Responsable
                </div>
                <div>
                    <a href="http://localhost/eco-responsable/public/frontend/pages/login.html" class="mr-4">Home</a>
                    <a href="http://localhost/eco-responsable/public/frontend/pages/admin/history.html" class="mr-4">Update History</a>
                    <a href="http://localhost/eco-responsable/public/frontend/pages/admin/admin_dashboard.html" class="mr-4">Admin Dashboard</a>
                    <a href="http://localhost/eco-responsable/public/frontend/pages/admin/statistics.html" class="mr-4">Statistics</a>
                    <a href="#" id="logout-btn">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Notification container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-4"></div>

    <!-- Statistics Content -->
    <section class="container mx-auto px-6 py-12">
        <h2 class="text-4xl font-bold text-center mb-8">Statistics</h2>
        <!-- Global Statistics -->
        <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-lg mb-12">
            <h3 class="text-4xl font-bold text-green-600 text-center my-8">Global Statistics</h3>
            <table class="w-full text-left border-collapse">
                <thead class="bg-green-500 text-white">
                    <th class="border-b p-4">Name</th>
                    <th class="border-b p-4">Value</th>
                </thead> 
                <tbody>
                    <tr>
                        <td class="border-b p-4">Total Users</td>
                        <td id="total-users" class="border-b p-4"></td>
                    </tr>
                    <tr>
                        <td class="border-b p-4">Total Weight</td>
                        <td id="total-weight" class="border-b p-4"></td>
                    </tr>
                    <tr>
                        <td class="border-b p-4">Total Profits</td>
                        <td id="total-profits" class="border-b p-4"></td>
                    </tr> 
                </tbody>
            </table>
        </div>

        <!-- Statistics by Commune -->
        <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-lg mb-12">
           <h3 class="text-4xl font-bold text-green-600 text-center my-8">Statistics by Commune</h3>
           <table class="w-full text-left border-collapse">
               <thead class="bg-green-500 text-white">
                   <tr>
                       <th class="border-b p-4">Commune</th>
                       <th class="border-b p-4">Total Users</th>
                       <th class="border-b p-4">Total Weight</th>
                       <th class="border-b p-4">Total Profits</th>
                   </tr>
               </thead>
               <tbody id="communes-stats-body">
                   <!-- Commune stats will be appended here -->
               </tbody>
           </table>
        </div>

        <!-- statistics graph sections -->
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mx-auto">
            <section class="max-w-3xl my-4 bg-white p-6 rounded-lg shadow-lg overflow-y-auto">
                <h2 class="text-4xl font-bold text-green-600 text-center my-8">Évolution du Poids des Bouteilles Collectées</h2>
                <canvas id="bottlesWeightChart"></canvas>
            </section>
            <section class="max-w-3xl my-4 bg-white p-6 rounded-lg shadow-lg overflow-y-auto">
                <h2 class="text-4xl font-bold text-green-600 text-center my-8">Évolution du Nombre de Participants</h2>
                <canvas id="participantsChart"></canvas>
            </section>
         </div>

    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center w-full py-6">
        <p>&copy; 2024 Eco-Responsable. All rights reserved.</p>
    </footer>

    <div id="notification-container" class="fixed top-0 right-0 m-4"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('You need to log in first.', 'error');
                window.location.href = 'http://localhost/eco-responsable/public/frontend/pages/login.html';
                return;
            }

            // Fetch global statistics
            const statsRes = await fetch('http://localhost:3000/api/report/global', {
                headers: {
                    'x-auth-token': token
                }
            });

            if (statsRes.status === 200) {
                const stats = await statsRes.json();
                document.getElementById('total-users').textContent = stats.totalUsers;
                document.getElementById('total-weight').textContent = stats.totalWeight + "Kg";
                document.getElementById('total-profits').textContent = stats.totalAccumulation;
            } else {
                showNotification('Failed to load global statistics.', 'error');
            }

           // Fetch statistics by commune
           const communeStatsRes = await fetch('http://localhost:3000/api/report/commune', {
                headers: {
                    'x-auth-token': token
                }
            });

            if (communeStatsRes.status === 200) {
                const communeStats = await communeStatsRes.json();
                const communesStatsBody = document.getElementById('communes-stats-body');
                communesStatsBody.innerHTML = '';

                // Append each commune's stats to the table
                communeStats.forEach(stat => {
                    const statRow = document.createElement('tr');
                    statRow.innerHTML = `
                        <td class="border-b p-4">${stat.commune}</td>
                        <td class="border-b p-4">${stat.totalUsers}</td>
                        <td class="border-b p-4">${stat.totalWeight}Kg</td>
                        <td class="border-b p-4">${stat.totalProfits}</td>
                    `;
                    communesStatsBody.appendChild(statRow);
                });
            } else {
                showNotification('Failed to load commune statistics.', 'error');
            }

        //Update statistics
        try {
        const updateRes = await fetch('http://localhost:3000/api/report/update-statistics', {
        method: 'POST',
        headers: {
            'x-auth-token': token
            }
        });

        if (updateRes.status == 200) {
            showNotification('No changes in statistics.', 'success');
        } else if (updateRes.status == 201) {
            showNotification('Statistics updated successfully.', 'success');
        } else {
            showNotification('Failed to update statistics.', 'error');
            return;
        }
        } catch (error) {
            console.error('Error:', error);
        }
            

        //fecth statistics for graph
            const res = await fetch('http://localhost:3000/api/report/statistics', {
            headers: {
                'x-auth-token': token
            }
        });

        if (res.status !== 200) {
            showNotification('Failed to load statistics.', 'error');
            return;
        }

        const data = await res.json();
        const dates = data.map(entry => entry.date);
        const bottlesWeight = data.map(entry => entry.bottlesWeight);
        const participants = data.map(entry => entry.participants);

        // Graphique pour l'évolution du poids des bouteilles collectées
        const ctx1 = document.getElementById('bottlesWeightChart').getContext('2d');
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Poids des bouteilles collectées (kg)',
                    data: bottlesWeight,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Poids (kg)'
                        }
                    }
                }
            }
        });

        // Graphique pour l'évolution du nombre de participants
        const ctx2 = document.getElementById('participantsChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Nombre de participants',
                    data: participants,
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Nombre de participants'
                        }
                    }
                }
            }
        });

            // Handle logout button click
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('token');
                window.location.href = 'index.html';
            });

            // Function to show notification
            function showNotification(message, type) {
                const notificationContainer = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `p-4 mb-4 rounded-lg shadow-md ${type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
                notification.textContent = message;
                notificationContainer.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        });
    </script>
</body>
</html>
